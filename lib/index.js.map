{"version":3,"sources":["index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["///<reference path=\"../typings/main.d.ts\"/>\r\nimport path = require(\"path\");\r\nimport express = require(\"express\");\r\nimport fs = require(\"fs\");\r\n\r\nconst exphbs = require(\"express-handlebars\");\r\nconst gzipStatic = require(\"connect-gzip-static\");\r\nconst vhost = require(\"vhost\");\r\n\r\ninterface SiteConfig {\r\n    public?: string;\r\n    views?: string;\r\n    viewsLayouts?: string;\r\n    defaultLayout?: string;\r\n    routes?: string;\r\n    domains?: string[];\r\n    port?: number;\r\n}\r\nexport function site_set_router(site: express.Express, root: string, cfg: SiteConfig): void {\r\n    const route_path = path.join(root, cfg.routes || \"routes\", \"index.js\");\r\n    if (!fs.existsSync(route_path))\r\n        return;\r\n    const route = require(route_path);\r\n    site.use(route(express.Router()));\r\n}\r\nexport function site_set_view_engine(site: express.Express, root: string, cfg: SiteConfig): void {\r\n    const view_path = cfg.views || \"views\";\r\n    if (!fs.existsSync(path.join(root, view_path)))\r\n        return;\r\n    site.set(\"view engine\", \".hbs\");\r\n    site.set(\"views\", path.join(root, view_path));\r\n\r\n    site.engine(\r\n        \".hbs\",\r\n        exphbs({\r\n            defaultLayout: cfg.defaultLayout || \"main\",\r\n            extname: \".hbs\",\r\n            layoutsDir: path.join(root, cfg.viewsLayouts || (view_path + \"/layouts/\"))\r\n        })\r\n    );\r\n}\r\n\r\nexport function site_set_static_index_file(site: express.Express, root: string, cfg: SiteConfig): void {\r\n    const static_root = path.join(root, cfg.public || \"public\");\r\n    if (!fs.existsSync(static_root))\r\n        return;\r\n    site.get(/.*\\//, (req, res) => {\r\n        const file1 = path.join(static_root, req.path, \"index.htm\");\r\n        fs.exists(file1, (exists) => {\r\n            if (exists)\r\n                return res.sendFile(file1);\r\n            const file2 = path.join(root, req.path, \"index.html\");\r\n            fs.exists(file2, (exists) => {\r\n                if (exists)\r\n                    return res.sendFile(file2);\r\n                res.status(404);\r\n                res.type(\"txt\").send(\"Not found\");\r\n            });\r\n        });\r\n    });\r\n}\r\nexport function site_set_static_root(site: express.Express, root: string, cfg: SiteConfig): void {\r\n    const static_root = path.join(root, cfg.public || \"public\");\r\n    if (!fs.existsSync(static_root))\r\n        return;\r\n    site.use(gzipStatic(static_root));\r\n}\r\n\r\nexport function site_setup(app: express.Express, root: string, cfg: SiteConfig): void {\r\n    app.set(\"x-powered-by\", false);\r\n\r\n    site_set_view_engine(app, root, cfg);\r\n    site_set_router(app, root, cfg);\r\n\r\n    site_set_static_root(app, root, cfg);\r\n    site_set_static_index_file(app, root, cfg);\r\n\r\n    app.use((req, res, next) => {\r\n        res.status(404);\r\n        res.type(\"txt\").send(\"Not found\");\r\n    });\r\n}\r\n\r\nexport function load_config(root: string): SiteConfig {\r\n    const cfg_file = path.join(root, \"site-config.json\");\r\n    const cfg = fs.existsSync(cfg_file) ? <SiteConfig>JSON.parse(fs.readFileSync(cfg_file, \"utf8\")) : {};\r\n    return cfg;\r\n}\r\nexport function site_create(root: string): express.Express {\r\n    const site = express();\r\n    site_setup(site, root, load_config(root));\r\n    return site;\r\n}\r\nexport function sub_site_create(root: string, cfg: SiteConfig): express.Express {\r\n    const site = express();\r\n    site_setup(site, root, cfg);\r\n    return site;\r\n}\r\nexport function site_container_add_site(container: express.Express, root: string) {\r\n    root=path.resolve(root);\r\n    const sites_path = path.join(root, \"sites\");\r\n    \r\n    if (!fs.existsSync(sites_path)) return;\r\n    fs.readdirSync(sites_path).forEach(name => {\r\n        console.log(\"loading site \" + name + \" ...\");\r\n        const sroot = path.join(sites_path, name);\r\n        const scfg = load_config(sroot);\r\n        const ssite = sub_site_create(sroot, scfg);\r\n        if (!scfg.domains) scfg.domains = [name];\r\n        scfg.domains.forEach(domain => {\r\n            console.log(\"\\tbinding domain \" + domain + \" ...\");\r\n            container.use(vhost(domain, ssite));\r\n        });\r\n    });\r\n}\r\n\r\nexport function site_container_create(root: string): express.Express {\r\n    const site = express();\r\n    site_container_add_site(site, root);\r\n    site_setup(site, root, load_config(root));\r\n    return site;\r\n}\r\n\r\n\r\n"]}